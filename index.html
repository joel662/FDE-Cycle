<!DOCTYPE html>
<html>
  <head>
    <title>P2P AR Multiplayer - FDE CYCLE</title>
    <!-- Dependencies -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <!-- FBX Model Component -->
    <script src="https://cdn.jsdelivr.net/gh/mflux/aframe-fbx-model-component/dist/aframe-fbx-model-component.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
      #ui-overlay {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 999;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      button {
        cursor: pointer;
        padding: 8px 12px;
        background: #4CC3D9;
        border: none;
        border-radius: 4px;
        font-weight: bold;
      }
      .status { font-size: 0.8em; color: #aaa; }
    </style>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <!-- UI Controls -->
    <div id="ui-overlay">
      <div id="room-info">Initializing Room...</div>
      <button id="copy-btn" style="display:none;">Copy Invite Link</button>
      <div id="peer-status" class="status">Waiting for connection...</div>
    </div>

    <!-- AR Scene -->
    <a-scene 
      embedded 
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
      cursor="rayOrigin: mouse"
      raycaster="objects: .interactable">
      
      <a-assets>
        <!-- External FBX Models -->
        <a-asset-item id="model-ch06" src="model/Ch06_nonPBR (1).fbx"></a-asset-item>
        <a-asset-item id="model-animation" src="animation/Crouch To Stand.fbx"></a-asset-item>
      </a-assets>

      <!-- Marker 1: Fetch Stage (Hiro) - Keep primitive for variety or if you want to test P2P quickly -->
      <a-marker preset="hiro" id="marker-fetch">
        <a-torus-knot 
          id="obj-fetch"
          class="interactable"
          radius="0.26" 
          radius-tubular="0.05" 
          position="0 0.5 0"
          material="color: #4CC3D9; metalness: 0.5; roughness: 0.2"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear">
        </a-torus-knot>
        <a-text value="FETCH" position="0 1.2 0" align="center" color="#4CC3D9"></a-text>
      </a-marker>

      <!-- Marker 2: Decode Stage (Kanji) - Using Ch06 FBX -->
      <a-marker preset="kanji" id="marker-decode">
        <a-entity 
          id="obj-decode"
          class="interactable"
          fbx-model="src: #model-ch06;" 
          scale="0.005 0.005 0.005"
          position="0 0 0"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear">
        </a-entity>
        <a-text value="DECODE" position="0 1.5 0" align="center" color="#EF2D5E"></a-text>
      </a-marker>

      <!-- Marker 3: Execute Stage (Barcode ID 0) - Using Crouch FBX with Animation -->
      <a-marker type="barcode" value="0" id="marker-execute">
        <a-entity 
          id="obj-execute"
          class="interactable"
          fbx-model="src: #model-animation;" 
          scale="0.005 0.005 0.005"
          position="0 0 0"
          animation-mixer="clip: *; loop: repeat; timeScale: 1">
        </a-entity>
        <a-text value="EXECUTE" position="0 1.5 0" align="center" color="#FFC65D"></a-text>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // --- P2P Networking Logic (PeerJS) ---
      const urlParams = new URLSearchParams(window.location.search);
      const roomParam = urlParams.get('room');
      const peer = new Peer(); 
      
      let conn = null;
      let isHost = !roomParam;

      peer.on('open', (id) => {
        if (isHost) {
          const roomUrl = `${window.location.origin}${window.location.pathname}?room=${id}`;
          document.getElementById('room-info').innerText = `Room ID: ${id.substring(0, 6)}`;
          document.getElementById('copy-btn').style.display = 'block';
          document.getElementById('copy-btn').onclick = () => {
            navigator.clipboard.writeText(roomUrl);
            alert('Invite link copied to clipboard!');
          };
        } else {
          document.getElementById('room-info').innerText = `Joining Room...`;
          connectToPeer(roomParam);
        }
      });

      peer.on('connection', (c) => {
        conn = c;
        setupConn();
        document.getElementById('peer-status').innerText = "Connected to Peer";
      });

      function connectToPeer(remoteId) {
        conn = peer.connect(remoteId);
        setupConn();
        conn.on('open', () => {
          document.getElementById('peer-status').innerText = `Connected to Host`;
          document.getElementById('room-info').innerText = `In Room: ${remoteId.substring(0, 6)}`;
        });
      }

      function setupConn() {
        conn.on('data', (data) => {
          if (data.type === 'interaction') {
            const el = document.getElementById(data.id);
            if (el) {
              // Simplified interaction for FBX: quick flash or nudge
              console.log("Peer interacted with:", data.id);
              el.setAttribute('animation__nudge', {
                property: 'position',
                to: '0 0.2 0',
                dir: 'alternate',
                dur: 100,
                loop: 2
              });
            }
          }
        });
      }

      function broadcast(data) {
        if (conn && conn.open) conn.send(data);
      }

      // --- Interaction Logic ---
      document.querySelectorAll('.interactable').forEach(el => {
        el.addEventListener('click', () => {
          // Visual feedback
          el.setAttribute('animation__nudge', {
            property: 'position',
            to: '0 0.2 0',
            dir: 'alternate',
            dur: 100,
            loop: 2
          });
          
          // Sync with peer
          broadcast({
            type: 'interaction',
            id: el.id
          });
        });
      });
    </script>
  </body>
</html>